<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Kitchen Label Builder — v2</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --label-width-mm:50.8mm; /* 2 inch */
    --label-height-mm:30mm;
  }
  body{font-family:Inter, Arial, Helvetica, sans-serif;margin:18px;background:#f7f8fb;color:#222}
  .wrap{max-width:980px;margin:0 auto;display:flex;gap:18px;align-items:flex-start}
  .controls{flex:1;min-width:300px;background:#fff;padding:18px;border-radius:10px;box-shadow:0 4px 18px rgba(20,30,60,0.06)}
  .preview-area{width:calc(var(--label-width-mm) + 32px);background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 24px rgba(12,20,40,0.06)}
  h1{font-size:18px;margin:0 0 12px 0}
  label{display:block;margin-top:10px;font-weight:600;font-size:13px}
  input,select,textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #e5e7eb;border-radius:6px}
  .row{display:flex;gap:8px}
  .row .col{flex:1}
  .btn{display:inline-block;padding:10px 14px;background:#0b76ff;color:#fff;border-radius:8px;border:none;cursor:pointer;margin-top:12px}
  .btn.secondary{background:#06b981}
  .small{font-size:13px;color:#666;margin-top:8px}
  #log{font-family:monospace;background:#111827;color:#fff;padding:8px;border-radius:6px;margin-top:12px;min-height:60px}
  .label-canvas { width:var(--label-width-mm); height:auto; background:#fff; border:1px solid #ddd; padding:6px; box-sizing: border-box; }
  .label-inner{ width:calc(var(--label-width-mm) - 12px); min-height: calc(var(--label-height-mm)); font-family: 'Helvetica Neue', Arial, sans-serif; font-size:12px; color:#111 }
  .label-heading{ text-align:center; font-weight:800; margin-bottom:6px; font-size:12px }
  .label-item{ font-weight:900; font-size:16px; margin:4px 0 }
  .label-meta{ font-size:11px; color:#333; margin:3px 0 }
  .label-footer{ font-size:10px; color:#666; margin-top:6px; text-align:center }
  .options{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .note{font-size:13px;color:#555;margin-top:8px}
  .muted{color:#666;font-size:13px}
  .template-select{margin-top:8px}
</style>
</head>
<body>
  <div style="max-width:1100px;margin:12px auto">
    <h1>Kitchen Label Builder — v2 (Preview & High-quality PDF)</h1>
    <div class="wrap">
      <div class="controls">
        <div>
          <label>Item name</label>
          <input id="item" placeholder="Paneer Butter Masala" value="Paneer Butter Masala"/>
          <label>Station</label>
          <select id="station">
            <option>Chef Section</option>
            <option>Burger Section</option>
            <option>Barista</option>
            <option>Pizza Section</option>
          </select>
          <div class="row">
            <div class="col">
              <label>Shelf life (hours)</label>
              <input id="shelf" value="24"/>
            </div>
            <div class="col">
              <label>Copies</label>
              <input id="copies" value="1"/>
            </div>
          </div>

          <label class="template-select">Template</label>
          <select id="template">
            <option value="compact">Compact (tall item)</option>
            <option value="detailed">Detailed (with footer)</option>
            <option value="bold">Bold large item</option>
          </select>

          <div class="options">
            <button id="previewBtn" class="btn">Preview</button>
            <button id="downloadPdfBtn" class="btn secondary">Download High-quality PDF</button>
            <button id="downloadPngBtn" class="btn" style="background:#374151">Download PNG</button>
          </div>

          <div class="note">Tip: Use “Download High-quality PDF” to get crisp vector-like output for label printing. If your printer prints images, this PDF will be high resolution.</div>
        </div>

        <div id="log" style="display:none"></div>
      </div>

      <div class="preview-area">
        <div style="text-align:center;margin-bottom:10px"><strong>Live Label Preview</strong></div>

        <!-- This wrapper is what we capture with html2canvas -->
        <div id="labelWrapper" class="label-canvas" role="img" aria-label="Label preview">
          <div id="labelInner" class="label-inner">
            <!-- injected -->
          </div>
        </div>

        <div class="muted" style="margin-top:8px">Paper width set to <strong>50.8mm (2")</strong>. You can change CSS variable --label-width-mm if needed.</div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const itemEl = document.getElementById('item');
  const stationEl = document.getElementById('station');
  const shelfEl = document.getElementById('shelf');
  const copiesEl = document.getElementById('copies');
  const previewBtn = document.getElementById('previewBtn');
  const downloadPdfBtn = document.getElementById('downloadPdfBtn');
  const downloadPngBtn = document.getElementById('downloadPngBtn');
  const templateEl = document.getElementById('template');
  const labelInner = document.getElementById('labelInner');
  const labelWrapper = document.getElementById('labelWrapper');

  function fmtDate(d){ const dd = String(d.getDate()).padStart(2,'0'); const mm = String(d.getMonth()+1).padStart(2,'0'); const hh = String(d.getHours()).padStart(2,'0'); const min = String(d.getMinutes()).padStart(2,'0'); return dd + '/' + mm + ' ' + hh + ':' + min; }

  function buildHtml(item,station,prepISO,shelfHours,template){
    const prep = new Date(prepISO);
    const expiry = new Date(prep.getTime() + shelfHours*3600*1000);
    if(template === 'compact'){
      return `
        <div class="label-heading">***TRUFFLES***</div>
        <div class="label-item">${escapeHtml(item)}</div>
        <div class="label-meta">Station: ${escapeHtml(station)}</div>
        <div class="label-meta">Prep: ${fmtDate(prep)}</div>
        <div class="label-meta">Use by: ${fmtDate(expiry)}</div>
      `;
    } else if(template === 'detailed'){
      return `
        <div class="label-heading">***TRUFFLES***</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="flex:1">
            <div class="label-item">${escapeHtml(item)}</div>
            <div class="label-meta">Station: ${escapeHtml(station)}</div>
            <div class="label-meta">Prep: ${fmtDate(prep)}</div>
            <div class="label-meta">Use by: ${fmtDate(expiry)}</div>
          </div>
        </div>
        <div class="label-footer">Made with ❤️ — Your Kitchen</div>
      `;
    } else {
      return `
        <div class="label-heading">***TRUFFLES***</div>
        <div class="label-item" style="font-size:18px">${escapeHtml(item)}</div>
        <div class="label-meta">Use by: ${fmtDate(expiry)} • ${escapeHtml(station)}</div>
      `;
    }
  }

  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  previewBtn.addEventListener('click', ()=>{
    const item = itemEl.value.trim() || 'Item';
    const station = stationEl.value;
    const shelf = parseInt(shelfEl.value || '24',10);
    const now = new Date().toISOString();
    labelInner.innerHTML = buildHtml(item,station,now,shelf,templateEl.value);
    // Ensure wrapper visible
    labelWrapper.style.display = 'block';
  });

  // High quality PDF: we render at a high scale to keep crispness then add to jsPDF
  downloadPdfBtn.addEventListener('click', async ()=>{
    try{
      if(!labelInner.innerHTML.trim()) previewBtn.click();

      const copies = Math.max(1, parseInt(copiesEl.value || '1',10));
      // Render at high scale for crispness:
      const scale = 3; // increase to 3x for high-res
      const canvas = await html2canvas(labelWrapper, {backgroundColor:'#ffffff', scale});
      // Prepare jsPDF
      const { jsPDF } = window.jspdf;
      // convert width from mm to px using canvas ratio:
      const mmWidth = 50.8;
      const pdf = new jsPDF({ unit: 'mm', format: [mmWidth, (canvas.height / canvas.width) * mmWidth] });

      // If multiple copies requested, create multiple pages
      const imgData = canvas.toDataURL('imagePNG');
      for(let i=0;i<copies;i++){
        if(i>0) pdf.addPage([mmWidth, (canvas.height / canvas.width) * mmWidth]);
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, mmWidth, (canvas.height / canvas.width) * mmWidth);
      }

      const filename = 'label-' + new Date().toISOString().slice(0,19).replaceAll(':','-') + '.pdf';
      pdf.save(filename);
      alert('PDF saved: ' + filename);
    }catch(e){
      console.error(e);
      alert('PDF creation failed: ' + e);
    }
  });

  // Download PNG
  downloadPngBtn.addEventListener('click', async ()=>{
    try{
      if(!labelInner.innerHTML.trim()) previewBtn.click();
      const canvas = await html2canvas(labelWrapper, {backgroundColor:'#ffffff', scale:3});
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = 'label-' + new Date().toISOString().slice(0,19).replaceAll(':','-') + '.png';
      link.click();
    }catch(e){
      console.error(e);
      alert('PNG creation failed: ' + e);
    }
  });

  // Render initial preview on load
  previewBtn.click();

})();
  <!-- LAN Print Integration: paste at end of body (after other scripts) -->
    
// ----------------- helpers -----------------
function uint8ToBase64(u8) {
  let CHUNK_SIZE = 0x8000;
  let index = 0, length = u8.length, result = '';
  while (index < length) {
    let slice = u8.subarray(index, Math.min(index + CHUNK_SIZE, length));
    result += String.fromCharCode.apply(null, slice);
    index += CHUNK_SIZE;
  }
  return btoa(result);
}

// Build ESC/POS buffer for 80mm/3" printer (text + bold timestamps + large item)
function buildEscPosBufferFromFields({ heading, item, station, prepISO, shelfHours }) {
  const encoder = new TextEncoder(); // UTF-8
  const ESC = 0x1B, GS = 0x1D;
  const parts = [];

  // init
  parts.push(Uint8Array.from([ESC, 0x40])); // ESC @

  // heading centered
  parts.push(Uint8Array.from([ESC, 0x61, 0x01])); // center
  parts.push(encoder.encode(heading + '\n'));

  // left align for rest
  parts.push(Uint8Array.from([ESC, 0x61, 0x00])); // left

  // item - double size + bold
  parts.push(Uint8Array.from([ESC, 0x21, 0x11])); // double width & height (if supported)
  parts.push(Uint8Array.from([ESC, 0x45, 0x01])); // bold on
  parts.push(encoder.encode(item + '\n'));
  parts.push(Uint8Array.from([ESC, 0x45, 0x00])); // bold off
  parts.push(Uint8Array.from([ESC, 0x21, 0x00])); // normal size

  // station
  parts.push(encoder.encode('Station: ' + station + '\n'));

  // timestamps (prep + expiry) as bold (per your request)
  const prep = new Date(prepISO);
  const expiry = new Date(prep.getTime() + (shelfHours * 3600 * 1000));
  const fmt = d => String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');

  parts.push(Uint8Array.from([ESC, 0x45, 0x01])); // bold on
  parts.push(encoder.encode('Prep: ' + fmt(prep) + '\n'));
  parts.push(encoder.encode('Use by: ' + fmt(expiry) + '\n'));
  parts.push(Uint8Array.from([ESC, 0x45, 0x00])); // bold off

  // small footer / notes (if present)
  // Note: keep ASCII only for compatibility; for logos or non-Latin text use raster image printing
  parts.push(encoder.encode('\n'));

  // feed and cut
  parts.push(Uint8Array.from([ESC, 0x64, 0x03])); // feed 3 lines
  parts.push(Uint8Array.from([GS, 0x56, 0x00]));  // cut (if supported)

  // concat
  const totalLen = parts.reduce((s,p) => s + p.length, 0);
  const out = new Uint8Array(totalLen);
  let offset = 0;
  for (const p of parts) { out.set(p, offset); offset += p.length; }
  return out;
}

// send to bridge
async function sendToBridge(u8, bridgeUrl = 'http://localhost:8001/print') {
  const base64 = uint8ToBase64(u8);
  const resp = await fetch(bridgeUrl, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ data: base64 })
  });
  return resp.json();
}

// ----------------- UI binding -----------------
// Adjust selectors below if your inputs use different IDs
async function printCurrentLabel() {
  try {
    // Read fields from your page — use your field ids (these match the v3 page)
    const item = document.getElementById('item').value.trim();
    const station = document.getElementById('station').value;
    const shelf = parseInt(document.getElementById('shelf').value || '24', 10);
    const notes = (document.getElementById('notes') || {}).value || '';
    const heading = '*** KITCHEN LABEL ***';
    const prepISO = new Date().toISOString();

    // Build lines and buffer
    const u8 = buildEscPosBufferFromFields({ heading, item, station, prepISO, shelfHours: shelf });

    // Optionally show feedback
    console.log('Sending print bytes to bridge...', u8.length);

    // send
    const result = await sendToBridge(u8);
    console.log('Bridge result:', result);
    alert('Print request sent: ' + (result.ok ? 'OK' : JSON.stringify(result)));
  } catch (err) {
    console.error('Print error', err);
    alert('Print failed: ' + err);
  }
}

// Add a "Print to LAN" button under your controls area (if not already present)
(function addPrintButton(){
  const controls = document.querySelector('.controls') || document.body;
  if (!document.getElementById('printToLanBtn')) {
    const b = document.createElement('button');
    b.id = 'printToLanBtn';
    b.textContent = 'Print to LAN';
    b.style.padding = '10px 12px';
    b.style.marginTop = '10px';
    b.onclick = printCurrentLabel;
    controls.appendChild(b);
  }
})();

</script>
</body>
</html>


